<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con RabbitMQ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        #mensajes {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

            button:hover {
                background-color: #45a049;
            }
    </style>
</head>
<body>
    <h1>Chat con RabbitMQ</h1>

    <div id="mensajes">
        <?php
        // Mostrar mensajes existentes
        mostrarMensajes();
        ?>
    </div>

    <form method="post">
        <textarea name="mensaje" placeholder="Escribe tu mensaje aquí..." required></textarea>
        <button type="submit" name="enviar">Enviar Mensaje</button>
    </form>

    <?php
    // Procesar el envío del mensaje
    if (isset($_POST['enviar'])) {
    $mensaje = htmlspecialchars($_POST['mensaje']);
    enviarMensajeRabbitMQ($mensaje);

    // Redirigir para evitar reenvío al refrescar
    header("Location: ".$_SERVER['PHP_SELF']);
    exit();
    }

    /**
    * Envía un mensaje a RabbitMQ
    */
    function enviarMensajeRabbitMQ($mensaje) {
    try {
    // Configuración de conexión
    $connection = new AMQPConnection([
    'host' => 'localhost',
    'port' => 5672,
    'vhost' => '/',
    'login' => 'guest',
    'password' => 'guest'
    ]);

    $connection->connect();

    // Crear canal
    $channel = new AMQPChannel($connection);

    // Declarar exchange
    $exchange = new AMQPExchange($channel);
    $exchange->setName('chat_exchange');
    $exchange->setType(AMQP_EX_TYPE_DIRECT);
    $exchange->declareExchange();

    // Declarar cola
    $queue = new AMQPQueue($channel);
    $queue->setName('chat_queue');
    $queue->declareQueue();

    // Enlazar cola al exchange
    $queue->bind('chat_exchange', 'chat_routing_key');

    // Publicar mensaje
    $exchange->publish($mensaje, 'chat_routing_key');

    $connection->disconnect();

    } catch (Exception $e) {
    echo "<p>Error al enviar mensaje: " . $e->getMessage() . "</p>";
    }
    }

    /**
    * Muestra los mensajes de la cola RabbitMQ
    */
    function mostrarMensajes() {
    try {
    // Configuración de conexión
    $connection = new AMQPConnection([
    'host' => 'localhost',
    'port' => 5672,
    'vhost' => '/',
    'login' => 'guest',
    'password' => 'guest'
    ]);

    $connection->connect();

    // Crear canal
    $channel = new AMQPChannel($connection);

    // Declarar cola
    $queue = new AMQPQueue($channel);
    $queue->setName('chat_queue');
    $queue->declareQueue();

    // Obtener mensajes (sin consumirlos)
    while ($envelope = $queue->get(AMQP_AUTOACK)) {
    if ($envelope !== false) {
    echo "<p>" . htmlspecialchars($envelope->getBody()) . "</p>";
    } else {
    break;
    }
    }

    $connection->disconnect();

    } catch (Exception $e) {
    echo "<p>Error al obtener mensajes: " . $e->getMessage() . "</p>";
    }
    }
    ?>
</body>
</html>